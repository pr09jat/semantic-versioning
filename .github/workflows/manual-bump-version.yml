name: Manual Version Bump
on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Select which part to bump"
        required: true
        default: "patch"
        type: choice
        options: [dev-increment, major, minor, patch, final]
      base_branch:
        description: "Base branch for the PR"
        required: true
        default: "master"
        type: string
      environment:
        description: "Target environment"
        required: true
        default: "development"
        type: choice
        options: [development, production]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: version-bump/${{ github.actor }}/${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.base_branch }}
          fetch-depth: 0
          fetch-tags: true
      - name: Check if user is allowed (based on CODEOWNERS)
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ” Checking CODEOWNERS access for ${GITHUB_ACTOR}"

          CODEOWNERS_FILE=""
          for path in ".github/CODEOWNERS" "CODEOWNERS" "docs/CODEOWNERS"; do
            if [[ -f "$path" ]]; then
              CODEOWNERS_FILE="$path"
              break
            fi
          done

          if [[ -z "$CODEOWNERS_FILE" ]]; then
            echo "âŒ CODEOWNERS not found in .github/, root, or docs/"
            exit 1
          fi

          echo "ðŸ“„ Found CODEOWNERS at: ${CODEOWNERS_FILE}"

          # Extract @handles (users or teams); allow by username only
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]\{1,\}\(/[A-Za-z0-9_.-]\{1,\}\)\?' "$CODEOWNERS_FILE" \
            | sed 's/^@//' \
            | awk -F/ '{print $1}' \
            | sort -u)

          echo "Allowed users:"
          echo "${ALLOWED_USERS}"

          echo "${ALLOWED_USERS}" | grep -qx "${GITHUB_ACTOR}" || { echo "ðŸš« ${GITHUB_ACTOR} not allowed"; exit 1; }
      - name: Validate base branch exists
        run: |
          if ! git rev-parse --verify "origin/${{ github.event.inputs.base_branch }}" >/dev/null 2>&1; then
            echo "âŒ Branch '${{ github.event.inputs.base_branch }}' does not exist"
            exit 1
          fi
          echo "âœ… Base branch '${{ github.event.inputs.base_branch }}' exists"
      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Configure Git author/committer
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create branch & bump
        shell: bash
        run: |
          set -euo pipefail
          git switch -c "$BRANCH_NAME"

          read_current() {
            uvx bumpver show --no-fetch | awk -F': ' '/Current Version/{print $2}'
          }

          BUMP="${{ github.event.inputs.bump }}"
          ENVIRON="${{ github.event.inputs.environment }}"

          case "$BUMP" in
            final)
              if [[ "$ENVIRON" != "production" ]]; then
                echo "âŒ 'final' bump is only allowed on production"
                exit 1
              fi
              CUR="$(read_current)"
              # Require a pre-release suffix like -dev.N (pattern allows -TAG.NUM)
              if [[ "$CUR" =~ -[A-Za-z]+\.[0-9]+$ ]]; then
                echo "ðŸ”” Finalizing pre-release: $CUR â†’ drop suffix"
                uvx bumpver update --tag=final
              else
                echo "âŒ Current version is already final ($CUR); nothing to finalize"
                exit 1
              fi
              ;;

            dev-increment)
              if [[ "$ENVIRON" == "production" ]]; then
                echo "âŒ dev-increment is not allowed on production"
                exit 1
              fi
              CUR="$(read_current)"
              if [[ "$CUR" =~ -dev\.[0-9]+$ ]]; then
                uvx bumpver update --tag=dev --tag-num
              else
                echo "âŒ dev-increment requires an existing -dev.N suffix (current: $CUR)"
                exit 1
              fi
              ;;

            major|minor|patch)
              case "$BUMP" in
                major) FLAG="--major" ;;
                minor) FLAG="--minor" ;;
                patch) FLAG="--patch" ;;
              esac

              if [[ "$ENVIRON" == "production" ]]; then
                # Production release with clean final version
                uvx bumpver update $FLAG --tag=final
              else
                # Development: bump base and ensure -dev.N train
                uvx bumpver update $FLAG --tag=dev --tag-num
                NEW="$(read_current)"
                if [[ ! "$NEW" =~ -dev\.[0-9]+$ ]]; then
                  uvx bumpver update --tag=dev --tag-num
                fi
              fi
              ;;

            *)
              echo "âŒ Unknown bump input: $BUMP"
              exit 1
              ;;
          esac

          echo "âœ… New version: $(read_current)"
      - name: Push branch
        run: |
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin "$BRANCH_NAME"

      - name: Open PR (create; cleanup branch on failure)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if gh pr create \
            --title "chore(release): version bump" \
            --body  "Automated version bump triggered by $GITHUB_ACTOR." \
            --base  "${{ github.event.inputs.base_branch }}" \
            --head  "$BRANCH_NAME"
          then
            echo "âœ… PR created successfully."
          else
            echo "âŒ PR creation failed. Cleaning up branch: $BRANCH_NAME"

            # Ensure authenticated remote for deletion
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

            # Detach HEAD so we can delete the local branch safely
            git checkout --detach >/dev/null 2>&1 || true

            # Delete remote & local branch (ignore if already gone)
            git push origin --delete "$BRANCH_NAME" || echo "Remote branch not found."
            git branch -D "$BRANCH_NAME" || echo "Local branch not found."

            exit 1
          fi
