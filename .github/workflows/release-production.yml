name: Create Release Tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Check if user is allowed (based on CODEOWNERS)
        id: check_access
        run: |
          echo "üîç Checking CODEOWNERS access for $GITHUB_ACTOR"

          # Try to find CODEOWNERS file
          CODEOWNERS_FILE=""
          for path in .github/CODEOWNERS CODEOWNERS docs/CODEOWNERS; do
            if [ -f "$path" ]; then
              CODEOWNERS_FILE="$path"
              break
            fi
          done

          if [ -z "$CODEOWNERS_FILE" ]; then
            echo "‚ùå CODEOWNERS file not found."
            exit 1
          fi

          echo "üìÑ Found CODEOWNERS at: $CODEOWNERS_FILE"

          # Extract all usernames from CODEOWNERS (lines starting with @)
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]*' "$CODEOWNERS_FILE" | sed 's/@//g' | sort -u)
          echo "Allowed users from CODEOWNERS:"
          echo "$ALLOWED_USERS"

          # Check if actor is in the list
          if echo "$ALLOWED_USERS" | grep -q "^${GITHUB_ACTOR}$"; then
            echo "‚úÖ Access granted"
          else
            echo "üö´ Access denied: $GITHUB_ACTOR is not in CODEOWNERS"
            exit 1
          fi
      - name: Validate source branch
        run: |
          if [[ ! "${{ github.ref_name }}" =~ ^release/sprint ]]; then
            echo "üö´ Invalid branch. Only branches starting with 'release/sprint' are allowed."
            exit 1
          fi
          echo "‚úÖ Branch validated: ${{ github.ref_name }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Extract version from file
        id: version
        run: |
          VERSION=$(grep -oP '(?<=__version__ = ")[^"]+' apps/version/__init__.py)
          if [ -z "$VERSION" ]; then
            echo "‚ùå Version not found in apps/version/__init__.py"
            exit 1
          fi
          echo "‚úÖ Found version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get latest tag
        id: latest
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          CURRENT="${{ steps.version.outputs.version }}"
          LATEST="${{ steps.latest.outputs.latest_tag }}"
          echo "Comparing $CURRENT with $LATEST"

          if [ "$LATEST" = "none" ]; then
            echo "üÜï No existing tags, proceeding to create $CURRENT"
          elif [ "$CURRENT" = "$LATEST" ]; then
            echo "üö´ Version $CURRENT already exists as tag."
            exit 1
          else
            echo "‚úÖ New version detected: $CURRENT (latest was $LATEST)"
          fi

      - name: Create Git tag and release
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.latest.outputs.latest_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè∑Ô∏è Creating new tag: $VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "$VERSION"
          git push origin "$VERSION"

          echo "üì¶ Determining previous tag..."
          PREVIOUS_TAG="${LATEST_TAG:-none}"
          echo "Previous tag: ${PREVIOUS_TAG:-<none>}"

          echo "üßæ Generating release notes..."
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES="Initial release."
          else
            # Fetch merged PRs between previous tag and current tag
            NOTES=$(gh api repos/${{ github.repository }}/pulls \
              --jq '.[] | select(.merged_at != null) | 
              select(.merge_commit_sha as $sha | 
              inside(["'$(git log --format="%H" ${PREVIOUS_TAG}..$VERSION | tr "\n" "," | sed "s/,$//")'"])) | 
              "* \(.title) by @\(.user.login) in \(.html_url)"' \
              2>/dev/null || echo "")

            if [ -z "$NOTES" ]; then
              NOTES=""
            else
              NOTES="## What's Changed\n${NOTES}"
            fi
          fi

          echo "üßæ Release Notes:"
          echo "$NOTES"

          echo "üöÄ Creating GitHub release..."
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "$NOTES" \
            --generate-notes
