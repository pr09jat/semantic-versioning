name: Create Release Tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          fetch-tags: true

      - name: Check if user is allowed (based on CODEOWNERS)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Checking CODEOWNERS access for ${GITHUB_ACTOR}"

          CODEOWNERS_FILE=""
          for path in ".github/CODEOWNERS" "CODEOWNERS" "docs/CODEOWNERS"; do
            if [[ -f "$path" ]]; then
              CODEOWNERS_FILE="$path"
              break
            fi
          done

          if [[ -z "$CODEOWNERS_FILE" ]]; then
            echo "‚ùå CODEOWNERS not found in .github/, root, or docs/"
            exit 1
          fi

          echo "üìÑ Found CODEOWNERS at: ${CODEOWNERS_FILE}"

          # Extract @handles (users or teams); allow by username only
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]\{1,\}\(/[A-Za-z0-9_.-]\{1,\}\)\?' "$CODEOWNERS_FILE" \
            | sed 's/^@//' \
            | awk -F/ '{print $1}' \
            | sort -u)

          echo "Allowed users:"
          echo "${ALLOWED_USERS}"

          echo "${ALLOWED_USERS}" | grep -qx "${GITHUB_ACTOR}" || { echo "üö´ ${GITHUB_ACTOR} not allowed"; exit 1; }

      - name: Validate source branch
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "${GITHUB_REF_NAME}" =~ ^release/sprint ]]; then
            echo "üö´ Invalid branch. Only branches starting with 'release/sprint' are allowed."
            echo "Ref name was: ${GITHUB_REF_NAME}"
            exit 1
          fi
          echo "‚úÖ Branch validated: ${GITHUB_REF_NAME}"

      - name: Extract version from file
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep -oP '(?<=__version__ = ")[^"]+' apps/version/__init__.py || true)
          if [[ -z "${VERSION:-}" ]]; then
            echo "‚ùå Version not found in apps/version/__init__.py"
            exit 1
          fi
          echo "‚úÖ Found version: ${VERSION}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Get latest tag
        id: latest
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force --prune --prune-tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest tag: ${LATEST_TAG}"
          echo "latest_tag=${LATEST_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Compare versions
        shell: bash
        run: |
          set -euo pipefail
          CURRENT="${{ steps.version.outputs.version }}"
          LATEST="${{ steps.latest.outputs.latest_tag }}"
          echo "Comparing ${CURRENT} with ${LATEST}"

          if [[ "${LATEST}" == "none" ]]; then
            echo "üÜï No existing tags, proceeding to create ${CURRENT}"
          elif [[ "${CURRENT}" == "${LATEST}" ]]; then
            echo "üö´ Version ${CURRENT} already exists as tag."
            exit 1
          else
            echo "‚úÖ New version detected: ${CURRENT} (latest was ${LATEST})"
          fi
      - name: Configure Git author/committer
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
      - name: Create Git tag and release
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          echo "üè∑Ô∏è Creating new tag: ${VERSION}"
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git tag -a "${VERSION}" -m "${VERSION}"
          git push origin "${VERSION}"

          echo "üöÄ Creating GitHub release..."
          gh release create "${VERSION}" \
            --title "${VERSION}" \
            --generate-notes
