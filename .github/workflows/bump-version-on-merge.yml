name: Update Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Select which part to bump"
        required: true
        default: "patch"
        type: choice
        options: [major, minor, patch]

permissions:
  contents: write # push branch
  pull-requests: write # create PR

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: version-bump/${{ github.actor }}/${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          # keep default credentials so git push over GITHUB_TOKEN works

      # (optional) your CODEOWNERS gate
      - name: Check if user is allowed (based on CODEOWNERS)
        run: |
          echo "ðŸ” Checking CODEOWNERS access for $GITHUB_ACTOR"
          CODEOWNERS_FILE=""
          for path in .github/CODEOWNERS CODEOWNERS docs/CODEOWNERS; do
            if [ -f "$path" ]; then CODEOWNERS_FILE="$path"; break; fi
          done
          if [ -z "$CODEOWNERS_FILE" ]; then echo "âŒ CODEOWNERS not found"; exit 1; fi
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]*' "$CODEOWNERS_FILE" | sed 's/@//g' | sort -u)
          echo "$ALLOWED_USERS" | grep -q "^${GITHUB_ACTOR}$" || { echo "ðŸš« $GITHUB_ACTOR not allowed"; exit 1; }

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Configure Git author/committer
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create branch & bump
        run: |
          set -euo pipefail
          git switch -c "$BRANCH_NAME"
          case "${{ github.event.inputs.bump }}" in
            major) FLAG="--major" ;;
            minor) FLAG="--minor" ;;
            *)     FLAG="--patch" ;;
          esac
          echo "ðŸ”¹ Bumping version with: $FLAG"
          uvx bumpver update $FLAG

      - name: Push branch
        run: |
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin "$BRANCH_NAME"

      - name: Open PR (create)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # or PAT/App token if your org blocks GITHUB_TOKEN
        run: |
          set -euo pipefail
          gh --version
          gh pr create \
            --title "chore(release): version bump" \
            --body  "Automated version bump triggered by $GITHUB_ACTOR." \
            --base  main \
            --head  "$BRANCH_NAME"

      - name: Verify PR & print URL (cleanup on missing)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Try to view PR by branch (positional arg, not --head)
          url=$(gh pr view "$BRANCH_NAME" --json url --jq .url 2>/dev/null || true)

          # Fallback: list PRs by head branch and grab the first open one
          if [ -z "${url:-}" ]; then
            url=$(gh pr list --head "$BRANCH_NAME" --state open --json url --jq '.[0].url' 2>/dev/null || true)
          fi

          if [ -z "${url:-}" ]; then
            echo "PR not created (blocked or missing). Cleaning up branch: $BRANCH_NAME"

            # Ensure remote is authenticated so deletion works
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

            # Detach HEAD to safely delete local branch
            git checkout --detach >/dev/null 2>&1 || true

            # Delete remote & local branch (ignore if already gone)
            git push origin --delete "$BRANCH_NAME" || echo "Remote branch not found."
            git branch -D "$BRANCH_NAME" || echo "Local branch not found."

            exit 1
          fi

          echo "PR URL: $url"
