name: Update Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Select which part to bump"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write # Allows pushing changes

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false # Disable GITHUB_TOKEN auth to prevent issues
          fetch-depth: 0 # Ensure full history is fetched for version bump

      - name: Check if user is allowed (based on CODEOWNERS)
        id: check_access
        run: |
          echo "üîç Checking CODEOWNERS access for $GITHUB_ACTOR"
          CODEOWNERS_FILE=""
          for path in .github/CODEOWNERS CODEOWNERS docs/CODEOWNERS; do
            if [ -f "$path" ]; then CODEOWNERS_FILE="$path"; break; fi
          done
          if [ -z "$CODEOWNERS_FILE" ]; then echo "‚ùå CODEOWNERS file not found"; exit 1; fi
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]*' "$CODEOWNERS_FILE" | sed 's/@//g' | sort -u)
          echo "$ALLOWED_USERS" | grep -q "^${GITHUB_ACTOR}$" || { echo "üö´ $GITHUB_ACTOR not allowed"; exit 1; }

      - uses: astral-sh/setup-uv@v3

      - name: Configure Git author/committer
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create a new branch for version bump
        run: |
          git checkout -b version-bump origini/main
          git pull
          # Bump version
          case "${{ github.event.inputs.bump }}" in
            major) FLAG="--major" ;;
            minor) FLAG="--minor" ;;
            *)     FLAG="--patch" ;;
          esac
          echo "üîπ Bumping version with flag: $FLAG"
          uvx bumpver update $FLAG

      - name: Push version bump branch
        run: |
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin version-bump

      - name: Create pull request for version bump
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Bump version"
          body: "Automated version bump"
          base: main # The branch you're pushing to
          branch: version-bump # The branch you've created with the version bump
          assignees: ${{ github.actor }}
          reviewers: "reviewer-username" # Add your required reviewers here, if needed
