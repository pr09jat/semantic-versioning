name: Update Version

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Select which part to bump"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Check if user is allowed (based on CODEOWNERS)
        id: check_access
        run: |
          echo "üîç Checking CODEOWNERS access for $GITHUB_ACTOR"

          # Try to find CODEOWNERS file
          CODEOWNERS_FILE=""
          for path in .github/CODEOWNERS CODEOWNERS docs/CODEOWNERS; do
            if [ -f "$path" ]; then
              CODEOWNERS_FILE="$path"
              break
            fi
          done

          if [ -z "$CODEOWNERS_FILE" ]; then
            echo "‚ùå CODEOWNERS file not found."
            exit 1
          fi

          echo "üìÑ Found CODEOWNERS at: $CODEOWNERS_FILE"

          # Extract all usernames from CODEOWNERS (lines starting with @)
          ALLOWED_USERS=$(grep -o '@[A-Za-z0-9_.-]*' "$CODEOWNERS_FILE" | sed 's/@//g' | sort -u)
          echo "Allowed users from CODEOWNERS:"
          echo "$ALLOWED_USERS"

          # Check if actor is in the list
          if echo "$ALLOWED_USERS" | grep -q "^${GITHUB_ACTOR}$"; then
            echo "‚úÖ Access granted"
          else
            echo "üö´ Access denied: $GITHUB_ACTOR is not in CODEOWNERS"
            exit 1
          fi

      - name: Setup UV
        uses: astral-sh/setup-uv@v3

      - name: Configure Git user
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
      - name: Use PAT for pushes
        run: |
          # Fine-grained PAT prefers username:PAT form
          git remote set-url origin "https://${{ github.actor }}:${{ secrets.G88JAT_PAT }}@github.com/${{ github.repository }}.git"
          git fetch --tags --force
      - name: Bump version and push
        run: |
          case "${{ github.event.inputs.bump }}" in
            major) FLAG="--major" ;;
            minor) FLAG="--minor" ;;
            patch|""|*) FLAG="--patch" ;;
          esac

          echo "üîπ Bumping version with flag: $FLAG"
          uvx bumpver update $FLAG --push
